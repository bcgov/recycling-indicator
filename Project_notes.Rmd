---
title: "Project_Notes"
author: "G Perkins"
date: "June 5, 2019"
output: 
  html_document: 
    toc : true
    toc_float: 
      collapsed: true
      smooth_scroll: false
      
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# EPR: Project Notes

The dataset provide as part of environment reporting legislation in pdf format and has been transposed to an excel. Detailed information about the program can be found here <https://www2.gov.bc.ca/gov/content/environment/waste-management/recycling/product-stewardship> 

This indicator will be replacing the tire recycling indicator <https://www2.gov.bc.ca/gov/content/environment/research-monitoring-reporting/reporting/environmental-reporting-bc/sustainability-indicators>


## Data summary: 

There are seven sets of data assessed for this indicator; 

- Beverage containers 
- Oil 
- Tires
- Paint-Flam_Pest (pfp)
- Elect
- Lead-Acid Batteries 
- Packaging and Printed Paper (ppp)

This data was combined with BC population data to calculate per person values per region. BC population data was manualy extracted per regional district for 2000 - 2018 using the BC Stats tool:  <https://www.bcstats.gov.bc.ca/apps/PopulationEstimates.aspx>

Note - May need to add Northern Rockies regional data as currently not pulled in as part of original query

Broadly, each of the above indicators has data on 1) quantity of items (kgs/litres) per regional district, 2) financial and 3) units moved. Finanial and unit data is compiled at the provincial scale (aspatial).  

Not all indicators had available data on these three catergories and collection years vary per indicator. 

Some changes to regional district names and associations (merging) was also addressed. This included updating regional district names (Queen Charlotte skeena to North Coast, Power river to Qathet, joining Comox and Strathcona into a single region)


## Work flow: 

1) All raw data is extracted from the excel worksheets and combined into a three dataframes using the 'clean.readxl.R' script. The dataframes are 'all.finance', 'all.units', 'all.regions'

2) Data is then loading into R and inital summaries and exploration is conducted using the '01_load.R' script 

3) To be continued......


** Note: during this process when typos and errors were found in the original
datasets manual updates were made and marked in highlighter to correct or double check with data custodian. 



## 1) Beverage containers 

Collected from multiple groups: Encorp Pacific (Canada), BC Brewers Recycles Collection Council. Both of these collect data on the units collected, weight collection (tonnes) with population data from 2006 - 2017. There is also some financial data ( revenue/ expenditure /deposits charged / units moved) and other (CO2 Equivalent Reduced (tonnes), weight of material)

Data exploration points to consider:  

- Regional and financial data grouped for Encorp and BCBRCC 
- BCBRC years are different (2007/08, 2008/09,2009/10) as BCBRCC reported to financial years (March 31st) over this period. In these cases data was assigned to preceeding year. 
- In Encorp data Comox and Strathcona joined (2007 to 2010), then split into two seperate regions from 2011 onwards. These are recorded seperately for BRCC. 
- Some data anomolied in Central Coast and Central Kootneys in 2015 were verified in pdf reports and found to be same as pdf report. 

### Regional data exploration 


```{r loadlibs, echo = TRUE, include = FALSE, message = FALSE}

x <- c("dplyr", "ggplot2", "tidyr", "stringr", 
       "bcmaps", "sf", "envreportutils") 
lapply(x, library, character.only = TRUE)
rm(x)  

```

```{r loaddata, echo=TRUE,include = FALSE}

# Read in population data -------------------------------
# BC Pop Stats (ignore and get directly from Stats Can)
# https://www.bcstats.gov.bc.ca/apps/PopulationEstimates.aspx
# manual export of population per regional district (2000 - 2018) and store in data folder

pop.0 <- read.csv(paste('data','Population_Estimates.csv',sep = "/"),
                header = TRUE)

pop <- pop.0 %>%
  mutate(regional_district = gsub("-", " ", Regional.District),
         n = Total, year = as.character(Year)) %>%
  select(-c('Ã¯..','Gender','Regional.District','Total',"Year")) %>%
  mutate(regional_district = ifelse(regional_district == "Powell River",
                                    "Qathet",
                             ifelse(regional_district == "Stikine",
                                           "Kitimat Stikine",
                             ifelse(regional_district == "Comox Valley",
                                                  "Comox Strathcona",
                          ifelse(regional_district == "Strathcona",
                                                     "Comox Strathcona",
                                                         regional_district)))))

pop <- pop %>%
   group_by(regional_district, year) %>%
   summarize(n = sum(n))

#######################################################################

source(paste('scratch','clean_readxl.R',sep = '/'))


# Beverage ------------------------------------------------------

regions <- all.regions %>% filter(type == 'bev')

priority <- regions %>%
      dplyr::filter(measure %in%
                  c("Absolute Collection-Units Collected-",
                    "Absolute Collection-Weight Collected (Tonnes)-")) %>%
      select(-c(organization,type)) %>%
      gather("year", "n",3:length(.)) %>%
      left_join(.,pop, by = c("regional_district","year")) %>%
      dplyr::rename(.,'pop' = 'n.y') %>%
      dplyr::rename('n' = 'n.x') %>%
      filter(year > 2005)

priority$n.pop = priority$n / priority$pop # this is not working in dplyr version

# break up into weight and units
units.per.cap <- priority %>%
      filter(measure == 'Absolute Collection-Units Collected-' )
weight.per.cap <-  priority %>%
      filter(measure == 'Absolute Collection-Weight Collected (Tonnes)-' )

``` 

```{r, include = TRUE}
# Units per capita
ggplot(units.per.cap, aes(year,n.pop)) +
      facet_wrap(~ regional_district) +
      geom_bar(stat = "identity",position = "dodge") +
      labs(title = "Regional Units Recycled per capita",
           x = "Year", y = "units per capita") +
      theme(axis.text.x = element_text(angle = 90,vjust=0.5))

```

This plot indicates some data anomolies in the 2015 datasets forthe central coast and Central Kootneys. After verifying with the original data  <https://www2.gov.bc.ca/assets/gov/environment/waste-management/recycling/recycle/beverage-containers/ar/bdl/2015_bdl_annual_report.pdf> this appears  the original data and true is same as pdf report
 
```{r weight per cap, echo=TRUE,include = FALSE}
#weight per capita
ggplot(weight.per.cap,aes(year,n.pop)) +
      facet_wrap(~ regional_district) +
      geom_bar(stat = "identity",position="dodge") +
      labs(title = "Regional weight of recycling (tonnes) per capita",
           x = "Year", y = "weight per cap (tonnes") +
      theme(axis.text.x = element_text(angle = 90))

```

The weight per capital graphs show similar trends. Perhaps some data annomolies with the metro Van and Peace River patterns are identical (suspicious?)

More intresting is the divergence from the BC average to enable regions to see how they compare to the provincial average (above or below). 

```{r prov compare, echo= FALSE, include = TRUE}

# calculate the provincial average
bc.units.per.cap <- units.per.cap %>%
      na.omit() %>%
      group_by(year) %>%
      summarise(bc_ave = mean(n.pop))

regional.units.per.cap <- units.per.cap %>%
      na.omit() %>%
      group_by(year,regional_district) %>%
      summarise(ave = mean(n.pop))

# join the regional and prov. ave data and calculate the difference
diff.df <- regional.units.per.cap %>%
      left_join(., bc.units.per.cap, by = 'year') %>%
      mutate(delta = ave-bc_ave) %>%
      mutate(response = ifelse(delta < 0,"below", "above")) %>%
      mutate(response = ifelse(delta == 0,"No data",response))
      

# Diverging barcharts
ggplot(diff.df, aes(x = regional_district,
                    y = delta,
                    label= delta)) +
      facet_wrap(~year) +
      geom_bar(stat='identity', aes(fill=response), width=.5)  +
      scale_fill_manual(name="Mileage",
                  labels = c("Above Average", "Below Average", "No Data"),
                  values = c("above" = "#008000", "below"="#FF0000", "no data" = 'grey')) +
      labs(title= "Regional difference from BC Ave",
           subtitle = " Bev units per capita") +
      coord_flip()

```

```{r, echo= FALSE, include = TRUE}
# Diverging Barcharts (all years)
ggplot(diff.df, aes(x = regional_district,
                    y = delta,
                    label = delta)) +
      geom_bar(stat='identity', aes(fill = response), width =.5)  +
      scale_fill_manual(name="Mileage",
                    labels = c("Above Average", "Below Average","No data"),
                    values = c("above" = "#008000", "below"="#FF0000", "no data" = 'grey')) +
  labs(title= "Regional difference from BC Ave",
       subtitle = " Bev units per capita") +
      coord_flip()

```

This provides an indication over time for each region for all years 2007-2018. This has the advantage of showing the standard error over this time (although appears to be highly influenced by outliers). Perhasp the Comox Strathcona measure needs to be investigated more as appears well below average but may indicate missing data etc.


### Finance data (provincial)

```{r bev finance, include = TRUE, echo =FALSE}
finance <- all.finance %>% filter(type == 'bev')

to.keep <- c('Deposits Charged','Deposits Refunded',
             'Expenditure-Consumer Awareness')

fdata <-finance %>%
      gather("year", "n", 4:length(.)) %>%
      mutate(n.m = n/1000000) %>%
      group_by(measure, year) %>%
      summarise(total = sum(n.m,na.rm = TRUE)) %>%
      filter(measure %in% to.keep)

ggplot(fdata, aes(year, total, fill = measure)) +
      geom_bar(stat="identity",position="dodge") +
      labs(title="Unclaimed deposits and consumer-expenditure",
           x = "Year", y = " Amount ($1,000,000)") +
      theme(axis.text.x = element_text(angle = 90))

```

This plot is hard to tell if there is not a strong correlation between with financial input into awareness programs and recycling, may need to adjust this per unit? or check if the awareness expenditure is for multiple programs (ECPOR and BCRCCC). 

To summarise this data we plotted Balance vs awareness expenditure: 

```{r, echo = FALSE, include = TRUE}
# look at revenue vs education $$
to.keep = c("Balance (Including Deposits Charged/Returned)",
            "Expenditure-Consumer Awareness") 

fdata <-finance %>%
  select(-c("organization","type"))%>%
  group_by(measure) %>%
  summarise_all(., sum, na.rm = TRUE) %>%
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000) %>%
  group_by(measure, year) %>%
  summarise(total = sum(n.m,na.rm = TRUE)) %>%
  filter(measure %in% to.keep)

ggplot(fdata, aes(year, total, fill = measure)) +
  geom_bar(stat="identity",position="dodge") +
  labs(title="Balance and consumer-awareness expenditure",
       x = "Year", y = " Amount ($1,000,000)") +
  theme(axis.text.x = element_text(angle = 90))

```
?? not sure what is going on here? The pattern is not easy to interpret

### Units Moved
Data for units includes earlier years of recycling, although this may not be comparable. 
Is there a difference in the units moved (recovered or sold over time?)

```{r, include = TRUE, echo = FALSE}
units <- all.units %>% filter(type == 'bev')

udata <- units %>%
      dplyr::select(-c(organization, type)) %>%
      group_by(measure) %>%
      summarise_all(., sum, na.rm = TRUE) %>%
      gather("year", "n", 2:length(.)) %>%
      mutate(n.m = n/1000000) 

# make a pretty graph
ggplot(udata, aes(year, n.m, fill = measure)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Recycled Units Returned and Sold",
               x = "Year",
               y = "Total no. (millions)") +
      theme(axis.text.x = element_text(angle = 90))

#calculate the recovery rate and make a line plot
sum.udata1 <- units  %>%
      select(-c(organization, type)) %>%
      gather("year", "n", 2:length(.)) %>%
      mutate(n.m = n/1000000) %>%
      group_by(measure,year) %>%
      summarise(total = sum(n.m, na.rm = TRUE)) %>%
      spread(., measure, total)

sum.udata1$RecoveryRate = sum.udata1$'Units Recovered' / sum.udata1$'Units Sold' *100
sum.udata1 <- sum.udata1[-1,]

ggplot(sum.udata1, aes(x = year, y = RecoveryRate))+
      geom_point() +
      ylim(60,100) +
      geom_hline(yintercept = 75, color = "red", lty = 2) +
      labs(title="Recycled Units Recovery Rate (%)",
              x = "Year",
              y = "Recovery Rate %")+
      theme(axis.text.x = element_text(angle = 90))

```
Substantial changes in 2007/2008 data may reflect the change in reporting (change from Dec 31 to March 31st reporting for the BCBRC organization)


Thoughts on Beverage recycling:

- Patterns in per capita recycling between regions could provide nice comparions. 
- To complement this further detail could be added (pop up for each regions; ie bar chart with changes over time)
- Perhaps financial and units moved could be rolled up wth other measures for relative comparisons, unless a specific question is to be address/highlighted.

- Would be nice to add a regional map with data (leaflet - etc)
- difference maps better than raw values ? Difference to average works with change per year indicated 


## 2) Lubricating Oil, Filters and containers. 

Collection broken in regional and temporal data sets from 2010 to 2017 including: 

- Used oil (litres per person) 
- Used filters (kg per person) 
- Containers (kg per person)
- Antifreeze (kg person)

Data exploration points to consider: 

Temporal and a-spatial data sets include financial, collection sites, units moved, and end fate for products. 
Collection sites does not look like much change in trends over time?
Could be opportunity to combine a number of measure (ie beverage together).

### Regional data exploration. 
Note these values were calculated and supplied as per capita values with no other raw data provide. 

```{r, include = TRUE, echo = FALSE}
regions <- all.regions %>% filter(type == 'oil')

pdata <- regions %>%
      select(-c(organization, type)) %>%
      filter(!regional_district == '') %>%
      gather("year", "n",3:length(.)) %>%
      filter(year >2009)

## do a basic graph to check it out
ggplot(pdata, aes(year, n, fill = measure)) +
      geom_bar(stat = "identity",position = "dodge") +
      labs(title = "Absolute collection (kg/litres) per person",
           x = "Year",
           y = "Collection (kg) per person")+
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5))

```
Used oil is a magnitude difference in volume. Repeat graph with out used oil values: 

```{r,include = TRUE, echo = FALSE}
# used oil is order of magnitude more!
pdata.1 <- pdata %>% dplyr::filter(!measure == 'oil_lt_pp')
pdata.1<- pdata.1[complete.cases(pdata.1), ]

## do a basic graph to check it out
ggplot(pdata.1,aes(year, n, fill = measure)) +
  geom_bar(stat="identity",position="dodge") +
  labs(title="Absolute collection (kg) per person", 
       x = "Year", 
       y = "Collection (kg) per person") +
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5))


```

This may be due to a number of data values being high / errors 

Comparison of data per regional district 
```{r oil regional , echo = TRUE, include = FALSE}
# calculate the provincial average
bc_units_per_cap_yr <- pdata %>%  # per yr
  na.omit() %>%
  group_by(year, measure) %>%
  summarise(BCave = mean(n))

bc_units_per_cap <- pdata %>%     # all years
  na.omit() %>%
  group_by(measure) %>%
  summarise(BCave = mean(n))

regional_units_per_cap_yr <- pdata %>%
  na.omit() %>%
  group_by(year, measure, regional_district) %>%
  summarise(ave = mean(n))

regional_units_per_cap <- pdata %>%
  na.omit() %>%
  group_by(measure, regional_district) %>%
  summarise(ave = mean(n))

# join the regional and prov. ave data and calculate the difference
diff.df <-left_join(regional_units_per_cap,
                    bc_units_per_cap,
                    by = c('measure')) %>%
          mutate(delta = ave - BCave,
                 response = ifelse(delta < 0, "below ave", "above ave"))

# join the regional and prov. ave data and calculate the difference per year
diff.df.yr <-left_join(regional_units_per_cap_yr,
                    bc_units_per_cap_yr,
                    by = c('measure','year')) %>%
                mutate(delta = ave - BCave,
                    response = ifelse(delta < 0,
                          "below ave", "above ave"))

```

Oil was seperated from other items (antifreeze, containers, filters) and regional districts were calculated and compared with the BC average. 

```{r, echo = FALSE, include = TRUE}
# split into oil and non - oil data sets 

diff.df.oil <- diff.df %>% 
  filter(measure == "oil_lt_pp")
diff.df.yr.oil <- diff.df.yr %>% 
  filter(measure == "oil_lt_pp")

diff.df <- diff.df %>% 
  filter(!measure == "oil_lt_pp")
diff.df.yr <- diff.df.yr %>% 
  filter(!measure == "oil_lt_pp")
  
# OIL : Diverging Barcharts ( all years combined : oil only )
p_dif.oil <- ggplot(diff.df.oil, aes(x = regional_district,
                          y = delta,label = delta)) +
        geom_point()+
        geom_bar(stat = 'identity',
                      aes(fill = response), width =.5)  +
        scale_fill_manual(name = "Mileage",
                      labels = c("Above Average", "Below Average"),
                      values = c("above ave" = "#00ba38",
                                    "below ave" = "#f8766d")) +
                labs(title = "Oil (lts_pp) region vs bc ave ", 
                     y = " Difference from BC Ave") +
         coord_flip() 
p_dif.oil


```

Need to check up on the raw data for the Northern Rockies, Peace River and Kitimat Stiking as seems like unusually high 


```{r, echo = FALSE, include = TRUE}
# OTHER mEASURES : Diverging Barcharts ( all years combined )
p_dif <- ggplot(diff.df, aes(x = regional_district,
                             y = delta,label = delta)) +
  facet_wrap(~measure)+
  geom_point()+
  geom_bar(stat = 'identity',
           aes(fill = response), width =.5)  +
  scale_fill_manual(name = "Mileage",
                    labels = c("Above Average", "Below Average"),
                    values = c("above ave" = "#00ba38",
                               "below ave" = "#f8766d")) +
  labs(title = "Regional difference from the average BC
                              units per capita recycling", y = " Difference from BC Ave") +
  coord_flip() #+
p_dif

```

Similar patterns might inidcate problem with the population data estimates rather than pattern. 
Other measures show general pattern of ......

```{r, echo = FALSE, include = TRUE}
# Diverging Barcharts ( per year )
p_dif_yr <- ggplot(diff.df.yr, aes(x = regional_district,
                             y = delta,label = delta)) +
  facet_wrap(~year)+
  geom_point()+
  geom_bar(stat = 'identity',
           aes(fill = response), width =.5)  +
  scale_fill_manual(name = "Mileage",
                    labels = c("Above Average", "Below Average"),
                    values = c("above ave" = "#00ba38",
                               "below ave" = "#f8766d")) +
  labs(title = "Regional difference from the average BC
                              units per capita recycling", y = " Difference from BC Ave") +
  coord_flip() #+
p_dif_yr

```

This might need some more detailed look through to split apart patterns.

### Financial (oil)

Finance data presented here concentrated on balance (expenditure and revenue). Other financial aspects could be included (ie; break down of expenditure and revenue). Finance data is not split between types of measure (ie oil, antifreeze etc.)

```{r, include = TRUE, echo = FALSE}
finance <- all.finance %>% filter(type == 'oil')

odata <- finance %>%
  dplyr::select(-c(organization, type)) %>%
  group_by(measure) %>%
  summarise_all(., sum, na.rm = TRUE) %>%
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000) 

to.keep <- c("Expenditure-Total","Revenue-Total", "Balance")

sum.fdata <- odata %>%
  group_by(measure, year) %>%
  summarise(total = sum(n.m,na.rm = TRUE)) %>%
  filter(measure %in% to.keep)

# Does spending more on consumer awareness decrease unclaimed deposits
ggplot(sum.fdata, aes(year, total, fill = measure)) +
  geom_bar(stat="identity", position = "dodge") +
  labs(title = " Oil Recycling Expenditure and Revenue", 
       x = "Year", y = " Amount ($1,000,000)")+ 
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5))

```

### Units (Oil)  

This data includes bc total values for a number of units measured.

```{r, include = TRUE, echo = FALSE}

# oil units moved -----------------------------------

units <- all.units %>% filter(type == 'oil')

udata <- units %>%
  dplyr::select(-c(organization, type)) %>%
  group_by(measure) %>%    
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000)

# summarise per year
sum.udata <- udata %>%
      group_by(measure,year) %>%
      summarise(total = sum(n.m,na.rm = TRUE))

# make a pretty graph
ggplot(sum.udata, aes(year, total, fill = measure)) +
  facet_wrap(~measure) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Recycled Units Returned and Sold",
       x = "Year", y = "Total no. (millions)") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")

## this needs some more work to split out the data types
#unique(sum.udata$measure) 
#to.keep <- c("Expenditure-Total","Revenue-Total", "Balance")
```
This needs some more refining as the type of measures are not equivalent for all of the types (oil, containers, oil filters etc.) For example the output options include ```r unique(sum.udata$measure) ```

General thoughts on oil dataset 
.....

## 3) Tires
The tire set only contains financial and unit data. No regional data is provided. 

### Finance data (tires)
```{r, echo = FALSE, include = TRUE}

finance <- all.finance %>% filter(type == 'tire')

tire.fdata  <- finance %>%
  dplyr::select(-c(organization, type)) %>%
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000) %>%
  filter(year > 2006)

to.keep <- c("Expenditure-Total","Revenue-Total",
             "Expenditure-Communications & Education",
             "Expenditure-Program Incentives",
             "Balance")

sum.fdata <- tire.fdata %>%
      group_by(measure,year) %>%
      summarise(total = sum(n.m,na.rm = TRUE)) %>%
      filter(measure %in% to.keep)

# Does spending more on consumer awareness decrease unclaimed deposits
#ggplot(sum.fdata, aes(year, total, fill = measure) +
#         geom_bar(stat = "identity", position="dodge") +
#         labs(title = "Tire Recycling Expenditure and Revenue",
#              x = "Year",
#              y = " Amount ($1,000,000)") +
#         theme(axis.text.x = element_text(angle = 90)))

```
This might need a bit more digging into to see the patterns 

### Units (tires)

The type of units aer broken into many subsets: 

```{r, include = TRUE, echo = FALSE}
units <- all.units %>% filter(type == 'tire')

udata <- tire_units %>%
      select(-c(organization, type)) %>%
      gather("year", "n",2:length(.)) %>%
      mutate(n.m = n/1000000)

to.keep <- c("Total Sold", "Total Collected")

sumd <- udata %>% group_by(measure)%>% summarise(no. = n())
print(sumd)

```

```{r, include=TRUE, echo = FALSE}
# summarise per year
sum.udata <- udata %>%
      group_by(measure,year) %>%
      summarise(total = sum(n.m,na.rm = TRUE)) %>%
      filter(measure %in% to.keep)

# make a pretty graph
ggplot(sum.udata, aes(year, total, fill = measure)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Recycled Units Returned and Sold",
           x = "Year",
           y = "Total no. (millions)") +
      theme(axis.text.x = element_text(angle = 90,vjust = 0.5))

sum.udata.l <- sum.udata %>%
      spread(measure, total) %>%
      mutate(prop.recovered = `Total Collected`/`Total Sold`)

ggplot(sum.udata.l, aes(x = year, y = prop.recovered))+
      geom_point() +
      ylim(0,1) +
      labs(title="Recycled Units Recovery Rate (%)",
          x = "Year", y = "Recovery Rate %")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

```

Interesting the recycling units reconvery rate has decreased over time. This is based on total collected and sold not split into subsets of data catergories. 


## 4) Electric 

Electric datasets include a combination of many seperate components including smoke alarm, thermo, etc ....

### Regional data 

```{r, include = TRUE, echo = FALSE}
## Elect -
edata <- all.regions %>% filter(type == "elect") %>%
  select(-c(type)) %>%
  group_by(organization, measure, regional_district)%>%
  summarise_all(., sum, na.rm = TRUE) %>%
  gather("year", "n",4:length(.)) %>%
  filter(year > 2009)

## do a basic graph to check it out
ggplot(edata,aes(year, n, fill = measure)) +
  #facet_wrap(~ measure ) +
  geom_bar(stat="identity",position="dodge") +
  labs(title="Absolute collection (raw)",
       x = "Year",
       y = "Collection (kg) per person")

```

more work to do on this one...

## 5) Paints - Flam - Pest (2000 - 2017) 

### Regional data 

```{r, include = TRUE, echo = FALSE}
pfp_recovery <- all.regions %>% filter(type == 'pfp')

pfp_data <- pfp_recovery %>%
  select(-c(organization,type)) %>%
  dplyr::filter(!regional_district == '') %>%
  group_by(measure, regional_district) %>%
  summarise_all(., sum, na.rm = TRUE) %>%
  gather("year", "n",3:length(.)) %>%
  left_join(.,pop, by = c("regional_district","year")) %>%
  dplyr::rename(.,'pop' = 'n.y') %>%
  dplyr::rename('n' = 'n.x') %>%
  filter(year > 2006) %>%
  mutate(unit.per.cap = n / pop)

## do a basic graph to check it out
ggplot(pfp_data, aes(year, n , fill = measure)) +
      geom_bar(stat = "identity",position = "dodge") +
      labs(title = "Absolute collection per person",
         x = "Year",
         y = "Total Tubskids Collected") +
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
              legend.position = "none")

```

The number of tubskids (raw data) collecte per year is continuing to increase.

```{r, include = TRUE, echo = FALSE}
# calculate the provincial average
bc_units_per_cap_yr <- pfp_data %>%  # per yr
      na.omit() %>%
      group_by(year, measure) %>%
      summarise(BCave = mean(unit.per.cap))

bc_units_per_cap <- pfp_data %>%     # all years
      na.omit() %>%
      group_by(measure) %>%
      summarise(BCave = mean(unit.per.cap))

regional_units_per_cap_yr <- pfp_data %>%
      na.omit() %>%
      group_by(year, measure, regional_district) %>%
      summarise(ave = mean(unit.per.cap))

regional_units_per_cap <- pfp_data %>%
      na.omit() %>%
      group_by(measure, regional_district) %>%
      summarise(ave = mean(unit.per.cap))

# join the regional and prov. ave data and calculate the difference
diff.df <-left_join(regional_units_per_cap,
                    bc_units_per_cap,
                    by = c('measure')) %>%
  mutate(delta = ave - BCave,
         response = ifelse(delta < 0, "below ave", "above ave"))

# join the regional and prov. ave data and calculate the difference per year
diff.df.yr <-left_join(regional_units_per_cap_yr,
                       bc_units_per_cap_yr,
                       by = c('measure','year')) %>%
  mutate(delta = ave - BCave,
         response = ifelse(delta < 0,
                           "below ave", "above ave"))

# Diverging Barcharts ( all years combined )
p_dif <- ggplot(diff.df, aes(x = regional_district,
                             y = delta,label = delta)) +
      facet_wrap(~measure)+
      geom_point()+
      geom_bar(stat = 'identity',
           aes(fill = response), width =.5)  +
      scale_fill_manual(name = "Mileage",
                    labels = c("Above Average", "Below Average"),
                    values = c("above ave" = "#00ba38",
                               "below ave" = "#f8766d")) +
      labs(title = "Regional difference from the average BC
                              units per capita recycling", y = " Difference from BC Ave") +
      coord_flip() #+

p_dif

```

Regional differences in pfp units per person 

```{r, include = TRUE, echo = FALSE}
p_dif_yr <- ggplot(diff.df.yr, aes(x = regional_district,
                             y = delta,label = delta)) +
  facet_wrap(~year)+
  geom_point()+
  geom_bar(stat = 'identity',
           aes(fill = response), width =.5)  +
  scale_fill_manual(name = "Mileage",
                    labels = c("Above Average", "Below Average"),
                    values = c("above ave" = "#00ba38",
                               "below ave" = "#f8766d")) +
  labs(title = "Regional difference from the average BC
                              units per capita recycling", y = " Difference from BC Ave") +
  coord_flip() + theme(legend.position = "none") #+

p_dif_yr

```

### Finance data (pfp)

```{r, echo = FALSE, include = TRUE}
finance <- all.finance %>% filter(type == 'pfp')

pfp.fdata <-finance %>%
  dplyr::select(-c(organization, type)) %>%
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000)

to.keep <- c("Expenditure-Total","Revenue-Total",
             "Expenditure-Education and Printed Materials",
             "Balance")

sum.fdata <- pfp.fdata %>%
      group_by(measure, year) %>%
      summarise(total = sum(n.m, na.rm = TRUE)) %>%
      filter(measure %in% to.keep)

# Does spending more on consumer awareness decrease unclaimed deposits
ggplot(sum.fdata, aes(year, total, fill = measure)) +
      geom_bar(stat="identity",position="dodge") +
      labs(title="PFP Recycling Expenditure and Revenue",
          x = "Year",
          y = " Amount ($1,000,000)") +
      theme(axis.text.x = element_text(angle = 90))

### possible to dig a bit deeper into this
ggplot(sum.fdata, aes(year, total)) +
      facet_wrap(~measure)+
      geom_bar(stat="identity",position="dodge") +
      labs(title="PFP Recycling Expenditure and Revenue",
       x = "Year",
       y = " Amount ($1,000,000)") +
      theme(axis.text.x = element_text(angle = 90))

# expenditure is very very low and not worth reporting.
#head(sum.fdata)

#sum.fdata %>% filter(measure == "Expenditure-Education and Printed Materials")

```

### Units moved (pfp)

```{r, include = TRUE, echo = FALSE}

pfp_units <- all.units %>% filter(type == 'pfp')

udata <- pfp_units %>%
  select(-c(organization, type)) %>%
  gather("year", "n",2:length(.)) %>%
  mutate(n.m = n/1000000)

#unique(udata$measure)

# summarise per year
sum.udata <- udata %>%
      group_by(measure,year) %>%
      summarise(total = sum(n.m,na.rm = TRUE)) %>%
      filter(!(measure == "All HHW Collected (Litres)"))

ggplot(sum.udata, aes(year, total, fill = measure)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Recycled Units Returned and Sold",
          x = "Year",
          y = "Total no. (millions)") +
      theme(axis.text.x = element_text(angle = 90),
            legend.position = 'none')

# split into different metrics (paint / aersol/ non aersol)


```
This requires more break down and digging. 

## 6) Pharma (2000 - 2017)

Note no finance data is availble for the pharma. dataset. 

### Regional data 

```{r, include = TRUE, echo = TRUE}

pharm_recovery <- all.regions %>% filter(type == "pharm")

ph_data <- pharm_recovery %>%
  select (-c(organization,type)) %>%
  dplyr::filter(!regional_district == '') %>%
  group_by(measure, regional_district) %>%
  summarise_all(., sum, na.rm = TRUE) %>%
  gather("year", "total",3:length(.)) %>%
  filter(year > 2007)

# note units only have data from 2008 - 2012
units.per.cap <- ph_data %>%
  filter(measure == 'Absolute Collection-Number of Containers-' )
weight.per.cap <-  ph_data %>%
  filter(measure == 'Absolute Collection-Weight Collected (kg)-' )

# Add population data set 
ph_data <- left_join(weight.per.cap, pop,
                     by = c("regional_district","year")) %>%
  mutate(weight.per.cap = total / n)

# calculate the provincial average
bc.weight.per.cap <- ph_data %>%
  na.omit() %>%
  group_by(year) %>%
  summarise(bc_ave = mean(weight.per.cap))

regional.weight.per.cap <- ph_data %>%
  na.omit() %>%
  group_by(year,regional_district) %>%
  summarise(ave = mean(weight.per.cap))

# join the regional and prov. ave data and calculate the difference
diff_df <- regional.weight.per.cap %>%
  left_join(.,bc.weight.per.cap, by = 'year') %>%
  mutate(delta = ave-bc_ave) %>%
  mutate(response = ifelse(delta < 0,"below", "above")) %>%
  mutate(response = ifelse(delta == 0,"No data", response))

# Diverging barcharts
ggplot(diff_df, aes(x = regional_district,
                    y = delta,
                    label= delta)) +
  facet_wrap(~year) +
  geom_bar(stat='identity', aes(fill=response), width=.5)  +
  scale_fill_manual(name="Mileage",
                    labels = c("Above Average", "Below Average", "No Data"),
                    values = c("above"="#00ba38", "below"="#f8766d", "no data" = 'grey')) +
  labs(title= "Difference from BC average BC") +
  coord_flip()

# Diverging Barcharts (all years)
ggplot(diff_df, aes(x = regional_district,
                    y = delta,
                    label = delta)) +
  geom_bar(stat = 'identity', aes(fill = response), width = .5)  +
  scale_fill_manual(name = "Mileage",
                    labels = c("Above Average",
                               "Below Average",
                               "No data"),
                    values = c("above" = "#00ba38",
                               "below" = "#f8766d",
                               "no data" = 'grey')) +
  labs(title = "Regional difference from the average BC units per capita recycling") +
  coord_flip()

```

NOte these are showing weights per capita not total numbers. 


### Units moved (Pharm) 

```{r, include = TRUE, echo = FALSE}
# pharm units moved -----------------------------------
pharm_units <- all.units %>% filter(type == "pharm")

udata <- pharm_units %>%
  select(-c(organization, type)) %>%
  gather("year", "n",2:length(.)) %>%
  mutate(n.t = n/1000)

to.keep = "Absolute Collection-Weight of Unused/Expired Medications Returned (kg)"

# summarise per year
sum.udata <- udata %>%
  group_by(measure,year) %>%
  summarise(total = sum(n.t, na.rm = TRUE)) %>%
  filter(measure %in% to.keep)

# make a pretty graph
ggplot(sum.udata, aes(year, total, fill = measure)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Weight of unused/expired medication returned",
       x = "Year", y = "Total weight (1000's kgs)") +
  theme(legend.position = "none",
            axis.text.x = element_text(angle = 90))


```


## 7) Packaging and Printed Paper (ppp)
### Regional data

```{r include = TRUE, echo = FALSE}

ppp_recovery <- all.regions %>% filter (type == "ppp")

ppp_data <- ppp_recovery %>%
  select(-c(organization, type)) %>%
  dplyr::filter(!regional_district == '') %>%
  gather("year", "total", 3:length(.)) %>%
  left_join(., pop, c("regional_district", "year")) %>%
  mutate(weight.per.cap = total / n)

# calculate the provincial average
bc.weight.per.cap <- ppp_data %>%
  na.omit() %>%
  group_by(year) %>%
  summarise(bc_ave = mean(weight.per.cap))

regional.weight.per.cap <- ppp_data %>%
  na.omit() %>%
  group_by(year, regional_district) %>%
  summarise(ave = mean(weight.per.cap))

# join the regional and prov. ave data and calculate the difference
diff_df <- regional.weight.per.cap %>%
  left_join(., bc.weight.per.cap, by = 'year') %>%
  mutate(delta = ave - bc_ave,
         response = ifelse(delta < 0,"below", "above")) %>%
  mutate(response = ifelse(delta == 0,"No data",response))

# Diverging barcharts
ggplot(diff_df, aes(x = regional_district,
                    y = delta,
                    label= delta)) +
  facet_wrap(~year) +
  geom_bar(stat='identity', aes(fill=response), width=.5)  +
  scale_fill_manual(name="Mileage",
                    labels = c("Above Average", "Below Average", "No Data"),
                    values = c("above"="#00ba38", "below"="#f8766d", "no data" = 'grey')) +
  labs(title= "Difference from BC average BC") +
  coord_flip()+
  theme(legend.position = "none")

# Diverging Barcharts (all years)
ggplot(diff_df, aes(x = regional_district,
                    y = delta,
                    label = delta)) +
  geom_bar(stat = 'identity', aes(fill = response), width = .5)  +
  scale_fill_manual(name = "Mileage",
                    labels = c("Above Average",
                               "Below Average",
                               "No data"),
                    values = c("above" = "#00ba38",
                               "below" = "#f8766d",
                               "no data" = 'grey')) +
  labs(title = "Regional difference from the average BC ") +
  theme(legend.position = "none") +
  coord_flip()

```

### Finance data (ppp)

```{r, include = TRUE, echo = FALSE}
ppp_finance <- all.finance %>% filter(type == 'ppp') 

ppp.fdata <- ppp_finance %>%
  select(-c(organization, type)) %>%
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000)

sum.fdata <- ppp.fdata %>%
  group_by(measure, year) %>%
  summarise(total = sum(n.m, na.rm = TRUE))

# Does spending more on consumer awareness decrease unclaimed deposits
ggplot(sum.fdata, aes(year, total, fill = measure)) +
  geom_bar(stat="identity",position="dodge") +
  labs(title="PFP Recycling Expenditure and Revenue",
       x = "Year",
       y = " Amount ($1,000,000)") +
  theme(axis.text.x = element_text(angle = 90))

```


### Units moved (ppp)
