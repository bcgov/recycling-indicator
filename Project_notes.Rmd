---
title: "Project_Notes"
author: "G Perkins"
date: "June 5, 2019"
output: 
  html_document: 
    toc : true
    toc_float: 
      collapsed: false
      smooth_scroll: false
      
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# EPR: Project Notes

The dataset provide as part of environment reporting legislation in pdf format and has been transposed to an excel. Detailed information about the program can be found here <https://www2.gov.bc.ca/gov/content/environment/waste-management/recycling/product-stewardship> 

This indicator will be replacing the tire recycling indicator<https://www2.gov.bc.ca/gov/content/environment/research-monitoring-reporting/reporting/environmental-reporting-bc/sustainability-indicators>


## Data summary: 

There are seven sets of data assessed for this indicator; 

- Beverage containers 
- Oil 
- Tires
- Paint-Flam_Pest (pfp)
- Elect
- Lead-Acid Batteries 
- Packaging and Printed Paper (ppp)

This data was combined with BC population data to calculate per person values per region. BC population data was manualy extracted per regional district for 2000 - 2018 using the BC Stats tool:  <https://www.bcstats.gov.bc.ca/apps/PopulationEstimates.aspx>

Broadly, each of the above indicators has data on 1) quantity of items (kgs/litres) per regional district, 2) financial and 3) units moved. Finanial and unit data is compiled at the provincial scale (aspatial).  

Not all indicators had available data on these three catergories and collection years vary per indicator. 

Some changes to regional district names and associations (merging) was also addressed. 


## Work flow: 

1) All raw data is extracted from the excel worksheets and combined into a three dataframes using the 'clean.readxl.R' script. The dataframes are 'all.finance', 'all.units', 'all.regions'

2) Data is then loading into R and inital summaries and exploration is conducted using the '01_load.R' script 

3) To be continued......


** Note: during this process when typos and errors were found in the original
datasets manual updates were made and marked in highlighter to correct or double check with data custodian. 



## 1) Beverage containers. 

Collected from multiple groups: Encorp Pacific (Canada), BC Brewers Recycles Collection Council. Both of these collect data on the units collected, weight collection (tonnes) with population data from 2006 - 2017. There is also some financial data ( revenue/ expenditure /deposits charged / units moved) and other (CO2 Equivalent Reduced (tonnes), weight of material)

Data exploration points to consider:  

- Regional and financial data grouped for Encorp and BCBRCC 
- BCBRC years are different (2007/08, 2008/09,2009/10) as BCBRCC reported to financial years (March 31st) over this period. In these cases data was assigned to preceeding year. 
- In Encorp data Comox and Strathcona joined (2007 to 2010), then split into two seperate regions from 2011 onwards. These are recorded seperately for BRCC. 
- Some data anomolied in Central Coast and Central Kootneys in 2015 were verified in pdf reports and found to be same as pdf report. 


#### Regional data exploration 

Note I still need to edit the comox Strathcona regions.

```{r loadlibs, echo=FALSE,include = FALSE}

#- Liquor distribution branch data and other catergory not included 2000 to #2006 only active for short time or vague metrics.
#- Some data anomolied in Central Coast and Central Kootneys in 2015 were #verified in pdf reports and found to be same as pdf report. 


x <- c("dplyr", "ggplot2", "tidyr", "stringr", 
       "bcmaps", "sf", "envreportutils") 
lapply(x, library, character.only = TRUE)
rm(x)  

```

```{r loaddata, echo=TRUE,include = FALSE}

# Read in population data -------------------------------
# BC Pop Stats (ignore and get directly from Stats Can)
# https://www.bcstats.gov.bc.ca/apps/PopulationEstimates.aspx
# manual export of population per regional district (2000 - 2018) and store in data folder

pop.0 <- read.csv(paste('data','Population_Estimates.csv',sep = "/"),
                header = TRUE)

pop <- pop.0 %>%
       mutate(regional_district = gsub("-", " ", Regional.District),
              n = Total, year = as.character(Year)) %>%
       select(-c('Ã¯..','Gender','Regional.District','Total',"Year"))

#######################################################################

source(paste('scratch','clean_readxl.R',sep = '/'))


# Beverage ------------------------------------------------------

regions <- all.regions %>% filter(type == 'bev')

priority <- regions %>%
      dplyr::filter(measure %in%
                  c("Absolute Collection-Units Collected-",
                    "Absolute Collection-Weight Collected (Tonnes)-")) %>%
      select(-c(organization,type)) %>%
      gather("year", "n",3:length(.)) %>%
      left_join(.,pop, by = c("regional_district","year")) %>%
      dplyr::rename(.,'pop' = 'n.y') %>%
      dplyr::rename('n' = 'n.x') %>%
      filter(year > 2006)

priority$n.pop = priority$n / priority$pop # this is not working in dplyr version

# break up into weight and units
units.per.cap <- priority %>%
      filter(measure == 'Absolute Collection-Units Collected-' )
weight.per.cap <-  priority %>%
      filter(measure == 'Absolute Collection-Weight Collected (Tonnes)-' )

``` 

```{r, include = TRUE}
# Units per capita
ggplot(units.per.cap, aes(year,n.pop)) +
      facet_wrap(~ regional_district) +
      geom_bar(stat = "identity",position = "dodge") +
      labs(title = "Regional Units Recycled per capita",
           x = "Year", y = "units per capita") +
      theme(axis.text.x = element_text(angle = 90))

```

This plot indicates some data anomolies in the 2015 datasets forthe central coast and Central Kootneys. After verifying with the original data  <https://www2.gov.bc.ca/assets/gov/environment/waste-management/recycling/recycle/beverage-containers/ar/bdl/2015_bdl_annual_report.pdf> this appears  the original data and true is same as pdf report
 
```{r weight per cap, echo=TRUE,include = FALSE}
#weight per capita
ggplot(weight.per.cap,aes(year,n.pop)) +
      facet_wrap(~ regional_district) +
      geom_bar(stat = "identity",position="dodge") +
      labs(title = "Regional weight of recycling (tonnes) per capita",
           x = "Year", y = "weight per cap (tonnes") +
      theme(axis.text.x = element_text(angle = 90))

```

The weight per capital graphs show similar trends. Perhaps some data annomolies with the metro Van and Peace River patterns are identical (suspicious?)

More intresting is the divergence from the BC average to enable regions to see how they compare to the provincial average (above or below). 

```{r prov compare, echo= FALSE, include = TRUE}

# calculate the provincial average
bc.units.per.cap <- units.per.cap %>%
      na.omit() %>%
      group_by(year) %>%
      summarise(bc_ave = mean(n.pop))

regional.units.per.cap <- units.per.cap %>%
      na.omit() %>%
      group_by(year,regional_district) %>%
      summarise(ave = mean(n.pop))

# join the regional and prov. ave data and calculate the difference
diff.df <- regional.units.per.cap %>%
      left_join(., bc.units.per.cap, by = 'year') %>%
      mutate(delta = ave-bc_ave) %>%
      mutate(response = ifelse(delta < 0,"below", "above")) %>%
      mutate(response = ifelse(delta == 0,"No data",response))
      

# Diverging barcharts
ggplot(diff.df, aes(x = regional_district,
                    y = delta,
                    label= delta)) +
      facet_wrap(~year) +
      geom_bar(stat='identity', aes(fill=response), width=.5)  +
      scale_fill_manual(name="Mileage",
                  labels = c("Above Average", "Below Average", "No Data"),
                  values = c("above" = "#008000", "below"="#FF0000", "no data" = 'grey')) +
      labs(title= "Regional difference from BC Ave",
           subtitle = " Bev units per capita") +
      coord_flip()

```

```{r, echo= FALSE, include = TRUE}
# Diverging Barcharts (all years)
ggplot(diff.df, aes(x = regional_district,
                    y = delta,
                    label = delta)) +
      geom_bar(stat='identity', aes(fill = response), width =.5)  +
      scale_fill_manual(name="Mileage",
                    labels = c("Above Average", "Below Average","No data"),
                    values = c("above" = "#008000", "below"="#FF0000", "no data" = 'grey')) +
  labs(title= "Regional difference from BC Ave",
       subtitle = " Bev units per capita") +
      coord_flip()

```

This provides an indication over time for each region for all years 2007-2018.


#### Finance data (provincial)

```{r bev finance, include = TRUE, echo =FALSE}
finance <- all.finance %>% filter(type == 'bev')

to.keep <- c('Deposits Charged','Deposits Refunded',
             'Expenditure-Consumer Awareness')

fdata <-finance %>%
      gather("year", "n", 4:length(.)) %>%
      mutate(n.m = n/1000000) %>%
      group_by(measure, year) %>%
      summarise(total = sum(n.m,na.rm = TRUE)) %>%
      filter(measure %in% to.keep)

ggplot(fdata, aes(year, total, fill = measure)) +
      geom_bar(stat="identity",position="dodge") +
      labs(title="Unclaimed deposits and consumer-expenditure",
           x = "Year", y = " Amount ($1,000,000)") +
      theme(axis.text.x = element_text(angle = 90))

```

There is not a strong correlation between with awareness, may need to adjust this per unit? or check if the awareness expenditure is for multiple programs (ECPOR and BCRCCC). Perhaps a comparison of revenue vs expenditure on education programs should be looked at? 

```{r, echo = TRUE, include = FALSE}
# look at revenue vs education $$
to.keep = c("Balance (Including Deposits Charged/Returned)",
            "Expenditure-Consumer Awareness") 

fdata <-finance %>%
  select(-c("organization","type"))%>%
  group_by(measure) %>%
  summarise_all(., sum, na.rm = TRUE) %>%
  gather("year", "n", 2:length(.)) %>%
  mutate(n.m = n/1000000) %>%
  group_by(measure, year) %>%
  summarise(total = sum(n.m,na.rm = TRUE)) %>%
  filter(measure %in% to.keep)

ggplot(fdata, aes(year, total, fill = measure)) +
  geom_bar(stat="identity",position="dodge") +
  labs(title="Unclaimed deposits and consumer-expenditure",
       x = "Year", y = " Amount ($1,000,000)") +
  theme(axis.text.x = element_text(angle = 90))


```
??

#### Units Moved
Is there a difference in the units moved (recovered or sold over time?)

```{r, include = TRUE, echo = FALSE}
units <- all.units %>% filter(type == 'bev')

udata <- units %>%
      dplyr::select(-c(organization, type)) %>%
      group_by(measure) %>%
      summarise_all(., sum, na.rm = TRUE) %>%
      gather("year", "n", 2:length(.)) %>%
      mutate(n.m = n/1000000) 

# make a pretty graph
ggplot(udata, aes(year, n.m, fill = measure)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Recycled Units Returned and Sold",
               x = "Year",
               y = "Total no. (millions)") +
      theme(axis.text.x = element_text(angle = 90))

#calculate the recovery rate and make a line plot
sum.udata1 <- units  %>%
      select(-c(organization, type)) %>%
      gather("year", "n", 2:length(.)) %>%
      mutate(n.m = n/1000000) %>%
      group_by(measure,year) %>%
      summarise(total = sum(n.m, na.rm = TRUE)) %>%
      spread(., measure, total)

sum.udata1$RecoveryRate = sum.udata1$'Units Recovered' / sum.udata1$'Units Sold' *100
sum.udata1 <- sum.udata1[-1,]

ggplot(sum.udata1, aes(x = year, y = RecoveryRate))+
      geom_point() +
      ylim(60,100) +
      geom_hline(yintercept = 75, color = "red", lty = 2) +
      labs(title="Recycled Units Recovery Rate (%)",
              x = "Year",
              y = "Recovery Rate %")+
      theme(axis.text.x = element_text(angle = 90))

```


 



Thoughts on Beverage recycling:

- Map regional data sets for presentation (leaflet)
- difference maps better than raw values ? Difference to average works with change per year indicated 
- could present some metrics within graphs (ie non - spatial data sets) 
- Northern Rockies missing population data - need to pull data from stats Canada per year 


# Lubricating Oil, Filters and containers. 

Collection broken in regional and temporal data sets from 2010 to 2017 including: 

- Used oil (litres per person) 
- Used filters (kg per person) 
- Containers (kg per person)
- Antifreeze (kg person)

Data exploration points to consider: 
Temporal and a-spatial data sets include financial, collection sites, units moved, and end fate for products. 
Collection sites does not look like much change in trends over time?
Could be opportunity to combine a number of measure (ie beverage together). Comox and Strathcona are treated separately in this analysis. 

Could also combine the % recover rate over time for different metrics in a single graph 

## Compare regional datasets for priority measures. 
Note these are already calculated per person (assuming the pop data is correct)




Used oil is a magnitude difference in volume. Repeat graph with out used oil values: 






# TO DO STILL : 

## Explore the non spatial data (all regions combined): Financial, units moved and other
1) Financial 




